<script id="span-row-template" type="template/underscore" charset="utf-8">
<div id="<%= span_id %>">
  <div class="handle">
    <div class="service-name">
      <span class="expander">+</span>
      <%= service_name %>
    </div>
  </div>
</div>
</script>

<script type="text/javascript">
  var spanParentObj = {};

  /*
     These spans represent span_id as key,
     whose value equals parent_id of the span

     In case parent_id is None, it indicates the
     parent most span
  */
  {% for key, value in spanParentDict.iteritems() %}
    spanParentObj['{{ key }}'] = '{{ value }}'
  {% endfor %}

  /*
     Fill in annotations structure.

     Annotation structure should contain all information we require
     for building simple annotations inside trace view
  */

  var annotations = [];

  {% for row in annotations %}
    annotations.push({
      'span_id': "{{ row['span_id'] }}",
      'span_name': "{{ row['span_name'] }}",
      'service_name': "{{ row['service_name'] }}",
      'value': "{{ row['value'] }}",
      'ipv4': "{{ row['ipv4'] }}",
      'port': "{{ row['port'] }}",
      'a_timestamp': "{{ row['a_timestamp'] }}"
    });
  {% endfor %}

  window.addEventListener('load', traceLoaded);

  function traceLoaded() {
    // template for span row
    var spanRowTemplate;

    // #trace-container DOM node
    var $traceContainer = $('#trace-container');

    // fetching and creating template for span row
    spanRowTemplate = _.template($('#span-row-template').html());

    // Custom sort annotations structure by timestamp value ASC
    var sortedAnnotations;

    // sorted annotations by timestamp ASC
    sortedAnnotations = _.sortBy(annotations, 'a_timestamp');

    // servcies used to display trace information
    var services;

    services = summarizeServices(spanParentObj, sortedAnnotations);

    for (var i = 0; i < services.length; i++) {

      // append spans to trace container
      $traceContainer.append( spanRowTemplate(structure[i]) );

      console.log(sortedAnnotations[i].service_name + " > " + sortedAnnotations[i].span_name);
    }
  }

  function summarizeServices(spanParentObj, sortedAnnotations) {
    var services = {}, serviceName, annotation;

    for (var i = sortedAnnotations.length - 1; i >= 0; i--) {
      annotation = sortedAnnotations[i];
      serviceName = annotation['service_name'];

      // if service is not inside services then create it
      if (!services[serviceName]) {
        services[serviceName] = {
          'annotations': []
        };
      }

      services[serviceName]['annotations'].push({
        'service_name': serviceName,
        'span_name': annotation['span_name']
      });

    }

    return services;
  }

</script>
